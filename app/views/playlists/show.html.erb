<div class="container mt-4">
  <!-- First Section: Playlist Card -->
  <div class="card-common card-playlist text-dark position-relative mb-4">
    <div class="card-header d-flex justify-content-between align-items-center p-2">
      <%= link_to 'x', playlist_path(@playlist), method: :delete, data: { confirm: 'Are you sure?' }, class: 'btn btn-danger btn-sm' %>
      <h5 class="mb-0 ml-auto"><%= @playlist.name %></h5>
    </div>

    <% if @playlist.cover_art.attached? %>
      <div class="card-img" style="background-image: url(<%= url_for(@playlist.cover_art) %>);"></div>
    <% else %>
      <div class="card-img" style="background-image: url('<%= asset_path('default_cover_art.jpg') %>');"></div>
    <% end %>
    <div class="card-footer d-flex justify-content-between align-items-center p-2">
      <small><%= format_time(@playlist.tracks.sum(:time)) %></small>
      <small><%= @playlist.tracks.count %> tracks</small>
    </div>
  </div>

  <!-- Harmonic Flow Score -->
  <% if @harmonic_analysis[:transitions].any? %>
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="mb-3">Harmonic Flow Analysis</h5>
            <div class="d-flex gap-3">
              <% quality_counts = @harmonic_analysis[:quality_counts] || {} %>
              <span class="badge bg-success">ðŸŸ¢ Perfect: <%= quality_counts[:perfect] || 0 %></span>
              <span class="badge bg-primary">ðŸ”µ Smooth: <%= quality_counts[:smooth] || 0 %></span>
              <span class="badge bg-warning">âš¡ Energy: <%= quality_counts[:energy_boost] || 0 %></span>
              <span class="badge bg-secondary">ðŸŸ¡ Rough: <%= quality_counts[:rough] || 0 %></span>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <h3 class="mb-0">
              <span class="badge <%= @harmonic_analysis[:score] >= 75 ? 'bg-success' : @harmonic_analysis[:score] >= 50 ? 'bg-warning' : 'bg-danger' %>">
                <%= @harmonic_analysis[:score] %>%
              </span>
            </h3>
            <small class="text-muted">Harmonic Flow Score</small>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Second Section: Tracks Table -->
  <h2 class="text-center">Tracks</h2>
  <table id="tracks-table" class="table table-striped table-hover"
         data-controller="sortable"
         data-reorder-url="<%= reorder_tracks_playlist_path(@playlist) %>">
    <thead class="thead-dark">
    <tr>
      <th>Order</th>
      <th>Name</th>
      <th>Artist(s)</th>
      <th>Key</th>
      <th>BPM</th>
      <th>Time</th>
      <th>Album</th>
      <th>Date Added</th>
      <th>Audio</th>
    </tr>
    </thead>
    <tbody>
    <% ordered_tracks = @playlist.playlists_tracks.order(:order).to_a %>
    <% ordered_tracks.each_with_index do |playlists_track, index| %>
      <tr data-id="<%= playlists_track.track.id %>">
        <td class="order-cell"><%= playlists_track.order %></td>
        <td>
          <%= link_to playlists_track.track.name, track_path(playlists_track.track), class: 'text-decoration-none text-dark' %>
        </td>
        <td>
          <% playlists_track.track.artists.each do |artist| %>
            <%= link_to artist.name, artist_path(artist), class: 'text-decoration-none text-dark' %>
            <%= ',' unless artist == playlists_track.track.artists.last %>
          <% end %>
        </td>
        <td><%= link_to playlists_track.track.key&.name, key_path(playlists_track.track.key), class: 'badge bg-info text-decoration-none' if playlists_track.track.key %></td>
        <td><%= playlists_track.track.bpm %></td>
        <td><%= format_time(playlists_track.track.time) %></td>
        <td><%= playlists_track.track.album %></td>
        <td><%= playlists_track.track.date_added %></td>
        <td>
          <% if playlists_track.track.audio_file.attached? %>
            <audio controls>
              <source src="<%= url_for(playlists_track.track.audio_file) %>" type="<%= playlists_track.track.audio_file.content_type %>">
              Your browser does not support the audio element.
            </audio>
          <% end %>
        </td>
      </tr>

      <!-- Transition Indicator Row -->
      <% if index < ordered_tracks.length - 1 %>
        <% transition = @harmonic_analysis[:transitions].find { |t| t[:from].id == playlists_track.track.id } %>
        <% if transition %>
          <tr class="transition-row">
            <td colspan="9" class="text-center py-1 bg-light"
                data-controller="transition-indicator"
                data-transition-indicator-from-track-value="<%= transition[:from].name %>"
                data-transition-indicator-to-track-value="<%= transition[:to].name %>"
                data-transition-indicator-from-key-value="<%= transition[:from].key&.name %>"
                data-transition-indicator-to-key-value="<%= transition[:to].key&.name %>"
                data-transition-indicator-quality-value="<%= transition[:quality] %>">
              <small class="transition-indicator <%= transition[:quality] %>">
                <%= transition[:indicator] %>
                <span class="text-muted ms-2">
                  <%= transition[:from].key&.name %> â†’ <%= transition[:to].key&.name %>
                </span>
              </small>
            </td>
          </tr>
        <% end %>
      <% end %>
    <% end %>
    </tbody>
  </table>
</div>
