<div class="container mt-4">
  <!-- Header Section with Set Info -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <h1 class="mb-2"><%= @dj_set.name %></h1>
          <% if @dj_set.description.present? %>
            <p class="text-muted"><%= @dj_set.description %></p>
          <% end %>

          <!-- Metadata Badges -->
          <div class="d-flex gap-2 mb-3 flex-wrap">
            <span class="badge bg-secondary"><i class="bi bi-music-note"></i> <%= @dj_set.tracks.count %> tracks</span>
            <span class="badge bg-secondary"><i class="bi bi-clock"></i> <%= @dj_set.total_duration_formatted %></span>
            <% if @dj_set.tracks.any? %>
              <span class="badge bg-secondary"><i class="bi bi-speedometer"></i> <%= @dj_set.average_bpm %> BPM avg</span>
            <% end %>
            <span class="badge bg-secondary"><i class="bi bi-calendar"></i> Updated <%= time_ago_in_words(@dj_set.updated_at) %> ago</span>
          </div>
        </div>

        <!-- Harmonic Score (Large) -->
        <div class="col-md-4 text-end">
          <% if @dj_set.tracks.count >= 2 %>
            <% score = @harmonic_analysis[:score] %>
            <h2 class="mb-2">
              <span class="badge fs-1 <%= score >= 75 ? 'bg-success' : score >= 50 ? 'bg-warning text-dark' : 'bg-danger' %>">
                <%= score %>%
              </span>
            </h2>
            <small class="text-muted">Harmonic Flow Score</small>
          <% end %>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="btn-group mt-3" role="group">
        <%= link_to edit_dj_set_path(@dj_set), class: 'btn btn-outline-secondary' do %>
          <i class="bi bi-pencil"></i> Edit
        <% end %>
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importModal">
          <i class="bi bi-file-earmark-arrow-up"></i> Import Tracks
        </button>
        <%= button_to duplicate_dj_set_path(@dj_set), method: :post, class: 'btn btn-outline-primary' do %>
          <i class="bi bi-files"></i> Duplicate
        <% end %>
        <%= link_to export_dj_set_path(@dj_set), class: 'btn btn-outline-success' do %>
          <i class="bi bi-download"></i> Export
        <% end %>
        <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#convertModal">
          <i class="bi bi-arrow-right-circle"></i> Convert to Playlist
        </button>
        <%= button_to dj_set_path(@dj_set), method: :delete, data: { confirm: "Delete #{@dj_set.name}?" }, class: 'btn btn-outline-danger' do %>
          <i class="bi bi-trash"></i> Delete
        <% end %>
      </div>
    </div>
  </div>

  <!-- Harmonic Flow Analysis -->
  <% if @dj_set.tracks.count >= 2 && @harmonic_analysis[:transitions].any? %>
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="mb-3">Harmonic Flow Analysis
              <small class="text-muted" style="font-size: 0.7em;" title="Scoring System v2.0: Rewards smooth transitions (3 pts), energy boosts (3 pts), and variety over safe same-key mixing (2 pts)">‚ÑπÔ∏è</small>
            </h5>
            <div class="d-flex gap-3 flex-wrap mb-3">
              <% quality_counts = @harmonic_analysis[:quality_counts] || {} %>
              <span class="badge bg-primary" title="Smooth transitions: ¬±1 key or relative major/minor (3 points each)">üîµ Smooth: <%= quality_counts[:smooth] || 0 %></span>
              <span class="badge bg-warning" title="Energy boosts: +7 positions for building peaks (3 points each)">‚ö° Energy: <%= quality_counts[:energy_boost] || 0 %></span>
              <span class="badge bg-success" title="Perfect matches: same key, safe but less interesting (2 points each)">üü¢ Perfect: <%= quality_counts[:perfect] || 0 %></span>
              <span class="badge bg-secondary" title="Rough transitions: incompatible keys (0 points)">üü° Rough: <%= quality_counts[:rough] || 0 %></span>
            </div>

            <!-- Detailed Score Breakdown (Scoring v2.0) -->
            <% if @detailed_analysis && @detailed_analysis[:final_score] != @detailed_analysis[:base_score] %>
              <div class="score-details">
                <small class="text-muted">
                  Base: <%= @detailed_analysis[:base_score] %>
                  <% if @detailed_analysis[:consecutive_penalty] > 0 %>
                    | <span class="text-danger">Penalty: -<%= @detailed_analysis[:consecutive_penalty] %></span>
                  <% end %>
                  <% if @detailed_analysis[:variety_bonus] > 0 %>
                    | <span class="text-success">Variety: +<%= @detailed_analysis[:variety_bonus] %></span>
                  <% end %>
                </small>
              </div>
            <% end %>

            <!-- Insights -->
            <% if @detailed_analysis && @detailed_analysis[:insights].any? %>
              <div class="insights mt-3">
                <% @detailed_analysis[:insights].each do |insight| %>
                  <div class="insight-item small"><%= insight %></div>
                <% end %>
              </div>
            <% end %>
          </div>
          <div class="col-md-4 text-end">
            <small class="text-muted"><%= @harmonic_analysis[:total_transitions] %> transitions analyzed</small>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- DJ Set Optimizer Section -->
  <% if @dj_set.tracks.count >= 2 %>
    <div class="card mb-4" data-controller="optimizer">
      <div class="card-body">
        <h5 class="mb-3">
          <a href="#" data-action="click->optimizer#toggleCollapse" class="text-decoration-none text-dark">
            üéõÔ∏è Optimize Track Order
            <small class="text-muted" style="font-size: 0.7em;">‚ñº</small>
          </a>
        </h5>

        <div style="display: none;" data-optimizer-target="collapse">
          <form action="<%= optimize_dj_set_path(@dj_set) %>" method="post" data-turbo="false">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Start With Track (Optional)</label>
                <select name="start_track_id" class="form-select" id="start-track-select">
                  <option value="">-- Any Track --</option>
                  <% @dj_set.tracks_in_order.each do |track| %>
                    <option value="<%= track.id %>"><%= track.name %> - <%= track.artists.map(&:name).join(", ") %></option>
                  <% end %>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">End With Track (Optional)</label>
                <select name="end_track_id" class="form-select" id="end-track-select">
                  <option value="">-- Any Track --</option>
                  <% @dj_set.tracks_in_order.each do |track| %>
                    <option value="<%= track.id %>"><%= track.name %> - <%= track.artists.map(&:name).join(", ") %></option>
                  <% end %>
                </select>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-12">
                <label class="form-label">
                  Harmonic Weight: <span data-optimizer-target="harmonicWeight">70</span>%
                  <small class="text-muted">(Energy Weight: <span data-optimizer-target="energyWeight">30</span>%)</small>
                </label>
                <input type="range" class="form-range" name="harmonic_weight"
                       data-optimizer-target="slider"
                       data-action="input->optimizer#updateWeights"
                       min="0" max="100" value="70" step="5">
                <small class="text-muted d-block">
                  Higher harmonic weight prioritizes key compatibility. Higher energy weight prioritizes BPM progression.
                </small>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Optimize Set</button>
              <% if session[:pre_optimization_order].present? %>
                <%= button_to "Revert to Original Order", revert_optimization_dj_set_path(@dj_set),
                              method: :patch, class: "btn btn-secondary",
                              data: { confirm: "Are you sure you want to revert to the original order?" } %>
              <% end %>
            </div>
          </form>

          <div class="alert alert-info mt-3 mb-0">
            <small>
              <strong>How it works:</strong><br>
              ‚Ä¢ 2-10 tracks: Brute force (guaranteed optimal)<br>
              ‚Ä¢ 11-25 tracks: Genetic algorithm (85-95% optimal)<br>
              ‚Ä¢ 26-50 tracks: Greedy with lookahead (70-85% optimal)<br>
              Maximum: 50 tracks
            </small>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Tracks Table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="mb-0">Tracks</h2>
      <%= link_to tracks_path(dj_set_id: @dj_set.id), class: 'btn btn-primary' do %>
        <i class="bi bi-plus-lg"></i> Add More Tracks
      <% end %>
    </div>
    <div class="card-body p-0">
      <% if @tracks.any? %>
        <div data-controller="track-remover" data-set-id="<%= @dj_set.id %>">
        <table class="table table-striped table-hover mb-0"
               data-controller="sortable"
               data-reorder-url="<%= reorder_tracks_dj_set_path(@dj_set) %>">
          <thead class="thead-dark">
          <tr>
            <th style="width: 40px;">
              <input type="checkbox" data-track-remover-target="selectAll" data-action="change->track-remover#toggleAll">
            </th>
            <th style="width: 40px;"></th>
            <th>#</th>
            <th>Name</th>
            <th>Artist(s)</th>
            <th>Key</th>
            <th>BPM</th>
            <th>Time</th>
            <th>Album</th>
            <th>Date Added</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody>
          <% ordered_tracks = @dj_set.dj_sets_tracks.includes(track: [:artists, :key]).order(:order).to_a %>
          <% ordered_tracks.each_with_index do |dj_sets_track, index| %>
            <tr data-id="<%= dj_sets_track.track.id %>" style="cursor: move;">
              <td class="text-center">
                <input type="checkbox" value="<%= dj_sets_track.track.id %>" data-track-remover-target="checkbox" data-action="change->track-remover#toggleTrack">
              </td>
              <td class="drag-handle text-center" style="cursor: grab;">
                <i class="bi bi-grip-vertical text-muted"></i>
              </td>
              <td class="order-cell"><%= dj_sets_track.order %></td>
              <td>
                <%= link_to dj_sets_track.track.name, track_path(dj_sets_track.track), class: 'text-decoration-none text-dark' %>
              </td>
              <td>
                <% dj_sets_track.track.artists.each do |artist| %>
                  <%= link_to artist.name, artist_path(artist), class: 'text-decoration-none text-dark' %>
                  <%= ',' unless artist == dj_sets_track.track.artists.last %>
                <% end %>
              </td>
              <td><%= link_to dj_sets_track.track.key&.name, key_path(dj_sets_track.track.key), class: 'badge bg-info text-decoration-none' if dj_sets_track.track.key %></td>
              <td><%= dj_sets_track.track.bpm %></td>
              <td><%= format_time(dj_sets_track.track.time) %></td>
              <td><%= dj_sets_track.track.album %></td>
              <td><%= dj_sets_track.track.date_added %></td>
              <td>
                <%= button_to remove_track_dj_set_path(@dj_set, track_id: dj_sets_track.track.id), method: :delete, class: 'btn btn-sm btn-outline-danger', data: { confirm: 'Remove this track?' } do %>
                  <i class="bi bi-x"></i>
                <% end %>
              </td>
            </tr>

            <!-- Transition Indicator Row -->
            <% if index < ordered_tracks.length - 1 %>
              <% transition = @harmonic_analysis[:transitions].find { |t| t[:from].id == dj_sets_track.track.id } %>
              <% if transition %>
                <tr class="transition-row">
                  <td colspan="11" class="text-center py-1 bg-light"
                      data-controller="transition-indicator"
                      data-transition-indicator-from-track-value="<%= transition[:from].name %>"
                      data-transition-indicator-to-track-value="<%= transition[:to].name %>"
                      data-transition-indicator-from-key-value="<%= transition[:from].key&.name %>"
                      data-transition-indicator-to-key-value="<%= transition[:to].key&.name %>"
                      data-transition-indicator-quality-value="<%= transition[:quality] %>">
                    <small class="transition-indicator <%= transition[:quality] %>">
                      <%= transition[:indicator] %>
                      <span class="text-muted ms-2">
                        <%= transition[:from].key&.name %> ‚Üí <%= transition[:to].key&.name %>
                      </span>
                    </small>
                  </td>
                </tr>
              <% end %>
            <% end %>
          <% end %>
          </tbody>
        </table>

        <!-- Track Removal Toolbar (appears when tracks selected) -->
        <div class="track-remover-toolbar" data-track-remover-target="toolbar">
          <div class="container d-flex justify-content-between align-items-center">
            <span data-track-remover-target="selectedCount" class="fw-bold">0 tracks selected</span>
            <div class="btn-group">
              <button type="button"
                      class="btn btn-outline-danger"
                      data-action="click->track-remover#removeSelected">
                <i class="bi bi-trash"></i> Remove Selected
              </button>
              <button type="button"
                      class="btn btn-secondary"
                      data-action="click->track-remover#clearSelection">
                Cancel
              </button>
            </div>
          </div>
        </div>
        </div>
      <% else %>
        <div class="text-center py-5">
          <p class="text-muted">No tracks in this set yet.</p>
          <%= link_to 'Browse Tracks', tracks_path(dj_set_id: @dj_set.id), class: 'btn btn-primary' %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Import Tracks Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: import_tracks_dj_set_path(@dj_set), method: :post, multipart: true, data: { controller: "fileselector" } do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="importModalLabel">Import Tracks from File</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <p class="text-muted">Import tracks from a tab-delimited file. Tracks will be appended to the end of this set.</p>

          <!-- File Upload -->
          <div class="mb-3">
            <label class="btn btn-secondary w-100">
              <span data-fileselector-target="setFileLabel">Select Set File</span>
              <%= f.file_field :file, accept: '.txt', class: 'form-control-file d-none', required: true, data: { fileselector_target: "setFile" } %>
            </label>
            <small class="text-muted d-block mt-2">Tab-delimited text file (.txt)</small>
          </div>

          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i> <strong>Note:</strong> Duplicate tracks will be skipped automatically.
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= f.submit 'Import Tracks', class: 'btn btn-primary' %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Convert to Playlist Modal -->
<div class="modal fade" id="convertModal" tabindex="-1" aria-labelledby="convertModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: convert_to_playlist_dj_set_path(@dj_set), method: :post, multipart: true do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="convertModalLabel">Convert to Playlist</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <p class="text-muted">Convert this set to a playlist with cover art.</p>

          <!-- Name -->
          <div class="mb-3">
            <%= f.label :name, 'Playlist Name', class: 'form-label' %>
            <%= f.text_field :name, value: @dj_set.name, class: 'form-control', required: true %>
          </div>

          <!-- Cover Art (required) -->
          <div class="mb-3">
            <%= f.label :cover_art, 'Cover Art', class: 'form-label' %>
            <%= f.file_field :cover_art, accept: 'image/*', class: 'form-control', required: true %>
            <small class="text-muted">Required for playlists</small>
          </div>

          <!-- Description (optional) -->
          <div class="mb-3">
            <%= f.label :description, class: 'form-label' %>
            <%= f.text_area :description, value: @dj_set.description, class: 'form-control', rows: 3 %>
          </div>

          <!-- Delete original set checkbox -->
          <div class="form-check">
            <%= f.check_box :delete_set, class: 'form-check-input' %>
            <%= f.label :delete_set, 'Delete original set after conversion', class: 'form-check-label' %>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= f.submit 'Convert to Playlist', class: 'btn btn-success' %>
        </div>
      <% end %>
    </div>
  </div>
</div>
