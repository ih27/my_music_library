<div class="container mt-4" data-controller="set-builder">
  <h1 class="text-center">Tracks</h1>

  <!-- SEARCH BAR -->
  <%= form_with(url: tracks_path, method: :get, local: true, class: 'mb-3', data: { controller: 'search' }) do %>
    <div class="input-group position-relative">
      <%= text_field_tag :search, params[:search], class: 'form-control pr-5', placeholder: 'Search tracks...', data: { search_target: 'input' } %>
      <button type="button" class="btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y" id="clear-search">&times;</button>
    </div>
  <% end %>

  <!-- HARMONIC COMPATIBILITY FILTER -->
  <%= form_with(url: tracks_path, method: :get, local: true, class: 'mb-3', data: { controller: 'harmonic-filter' }) do |f| %>
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Find Compatible Tracks</h5>
        <div class="row align-items-end">
          <div class="col-md-6">
            <label for="compatibleWith" class="form-label">Show tracks compatible with:</label>
            <%= f.select :compatible_with,
                options_for_select(
                  [['Select a track...', '']] +
                  Track.includes(:artists, :key).order(:name).map { |t|
                    ["#{t.name} - #{t.artists.map(&:name).join(', ')} (#{t.key&.name}, #{t.bpm} BPM)", t.id]
                  },
                  params[:compatible_with]
                ),
                {},
                {
                  class: 'form-select',
                  id: 'compatibleWith',
                  data: {
                    harmonic_filter_target: 'trackSelect',
                    action: 'change->harmonic-filter#trackChanged'
                  }
                }
            %>
            <%= f.hidden_field :search, value: params[:search] %>
            <%= f.hidden_field :sort, value: params[:sort] %>
            <%= f.hidden_field :direction, value: params[:direction] %>
          </div>
          <div class="col-md-4">
            <div class="form-check mb-2">
              <%= f.check_box :enable_bpm_filter,
                  {
                    class: 'form-check-input',
                    id: 'bpmFilterCheckboxIndex',
                    checked: params[:enable_bpm_filter].present?,
                    data: {
                      harmonic_filter_target: 'checkbox',
                      action: 'change->harmonic-filter#checkboxToggled'
                    }
                  }
              %>
              <label class="form-check-label" for="bpmFilterCheckboxIndex">
                Filter by BPM range
              </label>
            </div>
            <div class="bpm-slider-container" style="<%= 'display: none;' unless params[:enable_bpm_filter].present? %>">
              <label for="bpmRangeIndex" class="form-label small">
                <span data-harmonic-filter-target="sliderValue">Â±<%= params[:bpm_range] || 6 %> BPM</span>
              </label>
              <%= f.range_field :bpm_range,
                  in: 0..20,
                  value: params[:bpm_range] || 6,
                  class: 'form-range',
                  id: 'bpmRangeIndex',
                  data: {
                    harmonic_filter_target: 'slider',
                    action: 'input->harmonic-filter#sliderChanged'
                  }
              %>
            </div>
          </div>
          <div class="col-md-2">
            <%= link_to 'Clear Filter', tracks_path(search: params[:search], sort: params[:sort], direction: params[:direction]),
                class: 'btn btn-secondary w-100' %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div id="tracks-content">
    <!-- TABLE -->
    <table id="tracks-table" class="table table-striped table-hover" data-controller="sort">
      <thead class="thead-dark">
      <tr>
        <th style="width: 40px;">
          <input type="checkbox"
                 class="form-check-input"
                 data-set-builder-target="selectAll"
                 data-action="change->set-builder#toggleAll">
        </th>
        <th data-action="click->sort#sort" data-sort-column="name" class="sortable">Name <%= sort_icon('name') %></th>
        <th data-action="click->sort#sort" data-sort-column="artists.name" class="sortable">Artist(s) <%= sort_icon('artists.name') %></th>
        <th data-action="click->sort#sort" data-sort-column="keys.name" class="sortable">Key <%= sort_icon('keys.name') %></th>
        <th data-action="click->sort#sort" data-sort-column="bpm" class="sortable">BPM <%= sort_icon('bpm') %></th>
        <th data-action="click->sort#sort" data-sort-column="time" class="sortable">Time <%= sort_icon('time') %></th>
        <th data-action="click->sort#sort" data-sort-column="album" class="sortable">Album <%= sort_icon('album') %></th>
        <th>Date Added</th>
        <th data-action="click->sort#sort" data-sort-column="playlists.name" class="sortable">Playlists <%= sort_icon('playlists.name') %></th>
        <th>Audio</th>
      </tr>
      </thead>
      <tbody>
      <% @tracks.each do |track| %>
        <tr data-track-id="<%= track.id %>">
          <td>
            <input type="checkbox"
                   class="form-check-input"
                   value="<%= track.id %>"
                   data-set-builder-target="checkbox"
                   data-action="change->set-builder#toggleTrack">
          </td>
          <td><%= link_to track.name, track_path(track), class: 'text-decoration-none text-dark' %></td>
          <td>
            <% track.artists.each do |artist| %>
              <%= link_to artist.name, artist_path(artist), class: 'text-decoration-none text-dark' %>
              <%= ',' unless artist == track.artists.last %>
            <% end %>
          </td>
          <td><%= link_to track.key&.name, key_path(track.key), class: 'text-decoration-none text-dark' if track.key %></td>
          <td><%= track.bpm %></td>
          <td><%= format_time(track.time) %></td>
          <td><%= track.album %></td>
          <td><%= track.date_added %></td>
          <td>
            <% track.playlists.each do |playlist| %>
              <%= link_to playlist.name, playlist_path(playlist), class: 'text-decoration-none text-dark' %>
              <%= ',' unless playlist == track.playlists.last %>
            <% end %>
          </td>
          <td>
            <% if track.audio_file.attached? %>
              <audio controls>
                <source src="<%= url_for(track.audio_file) %>" type="<%= track.audio_file.content_type %>">
                Your browser does not support the audio element.
              </audio>
            <% else %>
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal" data-track-id="<%= track.id %>">Upload Audio</button>
            <% end %>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>

    <!-- PAGINATION -->
    <div class="d-flex justify-content-center">
      <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>
    </div>
  </div>

  <!-- Fixed Bottom Toolbar (Hidden by default) -->
  <div class="set-builder-toolbar" data-set-builder-target="toolbar">
    <div class="container d-flex justify-content-between align-items-center">
      <span data-set-builder-target="selectedCount" class="fw-bold">0 tracks selected</span>
      <div class="btn-group">
        <button type="button"
                class="btn btn-success"
                data-action="click->set-builder#showModal">
          <i class="bi bi-plus-lg"></i> Add to Set
        </button>
        <button type="button"
                class="btn btn-secondary"
                data-action="click->set-builder#clearSelection">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Set Selection Modal -->
  <div class="modal fade" id="setSelectionModal" tabindex="-1" aria-labelledby="setSelectionModalLabel" aria-hidden="true" data-set-builder-target="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="setSelectionModalLabel">Add Tracks to Set</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">
            Add <strong><span data-set-builder-target="modalCount">0</span> track(s)</strong> to:
          </p>

          <!-- Existing Sets List -->
          <% if DjSet.any? %>
            <div class="mb-3">
              <label class="form-label fw-bold">Existing Sets:</label>
              <div class="list-group" data-set-builder-target="setList">
                <% DjSet.order(updated_at: :desc).limit(10).each do |dj_set| %>
                  <button type="button"
                          class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                          data-action="click->set-builder#selectSet"
                          data-set-id="<%= dj_set.id %>">
                    <div>
                      <strong><%= dj_set.name %></strong>
                      <br>
                      <small class="text-muted"><%= dj_set.tracks.count %> tracks</small>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                  </button>
                <% end %>
              </div>
            </div>
            <hr>
          <% end %>

          <!-- Create New Set -->
          <div>
            <label class="form-label fw-bold">Or Create New Set:</label>
            <%= form_with model: DjSet.new, url: dj_sets_path, method: :post, data: { set_builder_target: 'newSetForm', action: 'submit->set-builder#submitNewSet' } do |f| %>
              <%= hidden_field_tag 'track_ids[]', '', multiple: true, data: { set_builder_target: 'trackIdsInput' } %>

              <div class="mb-3" data-controller="character-counter">
                <%= f.label :name, 'Set Name', class: 'form-label' %>
                <%= f.text_field :name, class: 'form-control', required: true, maxlength: 100, placeholder: 'e.g., Friday Night Set' %>
              </div>

              <div class="mb-3" data-controller="character-counter">
                <%= f.label :description, class: 'form-label' %>
                <%= f.text_area :description,
                    class: 'form-control',
                    rows: 2,
                    maxlength: 500,
                    placeholder: 'Optional description...',
                    data: {
                      character_counter_target: "input",
                      action: "input->character-counter#updateCount"
                    } %>
                <small class="text-muted">
                  <span data-character-counter-target="counter">0</span> / 500 characters
                </small>
              </div>

              <div class="d-flex gap-2">
                <%= f.submit 'Create & Add Tracks', class: 'btn btn-success flex-grow-1' %>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true" data-controller="upload fileselector" data-upload-target="modal" data-action="show.bs.modal->upload#show">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header d-flex justify-content-between align-items-center w-100">
        <h5 class="modal-title mx-auto" id="uploadModalLabel">Upload Audio File</h5>
        <button type="button" class="close position-absolute end-0 me-2" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <%= form_with(url: '', local: true, class: 'mb-3', data: { upload_target: 'form' }) do |form| %>
          <%= form.hidden_field :track_id, id: 'track-id', name: 'track[id]', data: { upload_target: 'trackId' } %>
          <div class="form-group mb-3">
            <label class="btn btn-secondary playlist-btn">
              <span data-fileselector-target="audioFileLabel">Select Audio File</span>
              <%= form.file_field :audio_file, class: 'form-control-file', name: 'track[audio_file]', data: { action: 'change->fileselector#updateAudioFileLabel', fileselector_target: "audioFile" } %>
            </label>
          </div>
          <div class="form-group text-center">
            <%= form.submit 'Upload', class: 'btn btn-primary playlist-btn-primary' %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
